<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment Failed</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    /* General Styles */
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background-color: #f8f9fa;
  color: #333;
  margin: 0;
  padding: 0;
}

/* Container for centering */
.container {
  max-width: 600px;
  margin: 100px auto;
  background-color: #fff;
  padding: 40px;
  border-radius: 12px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
  text-align: center;
}

/* Heading */
h2 {
  color: #dc3545; /* Bootstrap danger color */
  font-size: 2rem;
  margin-bottom: 15px;
}

/* Paragraph */
p {
  font-size: 1.1rem;
  color: #555;
  margin-bottom: 30px;
}

/* Button Styles */
.btn {
  display: inline-block;
  padding: 10px 20px;
  font-size: 1rem;
  text-decoration: none;
  border-radius: 6px;
  margin: 5px;
  transition: background-color 0.3s ease, transform 0.2s ease;
}

/* Button Colors */
.btn-secondary {
  background-color: #6c757d;
  color: #fff;
}

.btn-secondary:hover {
  background-color: #5a6268;
  transform: scale(1.05);
}

.btn-warning {
  background-color: #ffc107;
  color: #212529;
}

.btn-warning:hover {
  background-color: #e0a800;
  transform: scale(1.05);
}

  </style>
</head>
<body>
  <div class="container text-center mt-5">
    
    <h2 class="mt-4">Payment Failed!</h2>
    <p>Oops! Something went wrong during the transaction.</p>
    <div class="mt-3">
      
      <a href="/orders/view/<%= orderId %>" class="btn btn-secondary">View Order Details</a>
      
      <a href="#" id="retryBtn" data-orderid="<%= orderId %>" class="btn btn-warning">Retry Payment</a>

    </div>
  </div>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <script>

const retryBtn = document.getElementById("retryBtn");
  if (retryBtn) {
    retryBtn.addEventListener("click", async function(e) {
      e.preventDefault();
      const orderId = retryBtn.getAttribute("data-orderid");
      console.log("Retry clicked with orderId:", orderId);
      await retryPayment(orderId);
    });
  } 


   async function retryPayment(orderId) {
      
  try {
    const res = await fetch(`/retry-payment/${orderId}`);
    const response = await res.json();

    if (response.success) {
      console.log('retry payment response:',response)
      initiateRazorpayPayment(response); // Use the same existing function
    } else {
      alert("Retry failed. Please try again later.");
    }
  } catch (error) {
    console.error("Error during retry:", error);
  }
}



function initiateRazorpayPayment(response) {

const savedOrderId = response.savedOrderId; 
  const options = {
      key: response.key,  
      amount: response.amount,  
      currency: 'INR',
      order_id: response.razorpayOrderId,  
      name: response.customerName,
      description: "Order payment",
      image: "path_to_logo",  
      handler: function (paymentResponse) {
        console.log("Payment Response: ", paymentResponse);
          verifyPayment(paymentResponse, savedOrderId);
      },
      prefill: {
          name: response.customerName,
          email: response.customerEmail,
          contact: response.customerPhone
      },
      notes: {
          address: response.customerAddress,
          order_id: savedOrderId
      }
  };

  const razorpay = new Razorpay(options);

    
    razorpay.on('payment.failed', async function (response) {

      
      await fetch('/payment-failure', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
          orderId: savedOrderId,
          reason: response.error.description || "Payment failed"
      })
  });
      

      window.location.href = `/payment-failure?orderId=${savedOrderId}`; 
      
  });

  razorpay.open();
}


async function verifyPayment(paymentResponse, savedOrderId) {
  try {
    console.log("Redirecting with savedOrderId:", savedOrderId);

      const res = await fetch(`/verify-payment`, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify({
              razorpayOrderId: paymentResponse.razorpay_order_id,
              paymentId: paymentResponse.razorpay_payment_id,
              signature: paymentResponse.razorpay_signature,
              orderId: savedOrderId
          })
      });
      const result = await res.json();
      if (result.success) {
          window.location.href = `/orders/success/${savedOrderId}`;
      } else {
        window.location.href = `/order-failure?orderId=${savedOrderId}`;
        console.log("save order id is:",savedOrderId)
      }
  } catch (error) {
      console.error("Error verifying payment:", error);
      window.location.href = `/order-failure?orderId=${savedOrderId}`;
  }
}


  </script>
</body>
</html>
